---
title: "Tutorial and User Evaluation"
---
```{r, fig.show='hide', include=FALSE}
library(TSPatternQuery)
library(xts)
```

This page contains several exercises that may be used as a tutorial for the TSPatternQuery package. Should you wish to help by providing feedback, you may also participate in the user evaluation. Instructions for doing so are included in the next section.

#Evaluation Preamble

The aim of this evaluation is to gain feedback on the TSPatternQuery package. It is important to involve users in the design of software packages so to ensure that software developed not only solves the problem, but is also usable. This evaluation is set up so that you may do it on your own. Simply follow the instructions given in this document and answer the questionnaire at the end. The exercises below will require you to download a package in RStudio and use it on time series data that will be provided. At the end of the exercises, you will be instructed to save and send me the contents of an .Rhistory file containing everything that you typed into the R console during this session. The only other data collected during this evaluation will be your answers to the questionnaire. If you have any questions, feel free to contact me via email at joshanthonymarsh (AT) gmail (DOT) com. The purpose of this evaluation is not to test your ability. Should you find a particular task difficult, please indicate so in the questionnaire (or by emailing me). This is likely an indicator that something is deficient in the software or its documentation, and is useful feedback. You are welcome to withdraw from the experiment at any time. **At this point, please send me an email at joshanthonymarsh (AT) gmail (DOT) com stating that you agree to take part in this evaluation.** An email including your name and the sentence "I agree to take part in the TSPatternQuery evaluation." will suffice. I also encourage you to include any questions that you may have in this email. If you do include questions in your email, please wait for me to get back to you before you begin the evaluation.

**Please note** that I have intentionally avoided describing the TSPatternQuery tool on this evaluation page. Part of what is being evaluated is the documentation for the package. Please click the "Home" button at the top of this page to view the vignette for this package. You are encouraged to read as much of the vignette as you feel is necessary to understand and work with the TSPatternQuery package.

#Part 1: Setup

It is recommended that you use RStudio for the following exercises. If you do not already have RStudio installed, then you may download it from this link: [Download RStudio](https://www.rstudio.com/). Alternatively, you may launch RStudio in a web browser using [rollApp RStudio](https://www.rollapp.com/app/rstudio). The second option may result in slower package download and execution times.

Open a new session in RStudio and navigate to an empty directory. If you are participating in the evaluation, you may call this directory "evaluation". Set this directory as your working directory using the `setwd("<Path to your directory>")` command. The main reason for doing this is because you will be creating a new "evaluation.Rhistory" file within the working directory at the end of this evaluation. This file will contain everything that you have typed during this session, and you will be instructed to upload its contents to a google form. 

Once you have set the working directory, enter the following commands into the R console.
```{r, fig.show='hold', eval=FALSE}
devtools::install_github("joshmarsh/TSPatternQuery")
library(TSPatternQuery)
library(xts)
```

You may optionally add the `build_vignettes=TRUE` parameter to `devtools::install_github("joshmarsh/TSPatternQuery")`, however the vignette for TSPatternQuery may be more easily viewed by clicking the Home button at the top of this screen. You do not need to read the vignette in it's entirety. It is there for you to reference if you get stuck at any point.

#Part 2: Pattern Template and Matching Threshold

Run the following command in the R console to import a time series for this exercise.


<p style="color:red;">TODO: Import paths probably wont work given their working directory isnt inside TSPatternQuery. Change these so they will work for the participants.</p>

```{r, fig.show='hold', eval=TRUE}
part2.ts <- xts(read.csv("tutorial_data/part2_ts.csv")[[2]], 
              order.by = as.POSIXct(read.csv("tutorial_data/part2_ts.csv")[[1]]))
```

Using the `CreateCustomTimeSeries` function, please define a pattern template in order to find the following pattern. You may name it `part2.pattern`. Notice that the points of the pattern are spaced in 5 second intervals.

```{r, echo=FALSE, fig.show='hold', fig.align='center'}
plot(
    x = c(0,5, 10, 15, 20, 25, 30),
    y = c(0, -1, 2, -4, 2, -1, 0), 
    type="l", 
    xlab = "Seconds", 
    ylab = "Values"
    )
```

Once you have defined the pattern, use the `Query` function to find occurrences of the pattern in the timesiers that you imported. You may at first use the *timeseries* and **pattern.template** only. You will likely notice that the Query functions finds multiple matches. If you do not show any matches, there may be a problem with your pattern template. 

Set the **return.matched.patterns** parameter to TRUE in order to return a list of the windows that have been matched. Plot these so that you can see how successful your query has been. 

Next, try incrasing the **spearmans.rho.threshold** until you are satisfied that your query isn't too permissive. You may then move on to the next section.

#Part 3: Window Length 

Run the following command in the R console to import a time series for this exercise.
```{r, fig.show='hold', eval=TRUE}
part3.ts <- xts(read.csv("tutorial_data/part3_ts.csv")[[2]], 
              order.by = as.POSIXct(read.csv("tutorial_data/part3_ts.csv")[[1]]))
```

Run the following command in the R console to create a pattern template. This pattern is the same shape as the one that you used in part 2, however it is being provided to you this time to ensure that it is correct.
```{r, fig.show='hold', eval=TRUE}
part3.pattern <- CreateCustomTimeSeries(
  values = c(0, -1, 2, -4, 2, -1, 0),
  intervals = c(5,5,5,5,5,5)
)
```

Go ahead and run the Query function with the pattern template and time series. It should not find any matches. This is because the length of the sliding window is incorrect. It has been set to 30 seconds in the code (The vector `c(5,5,5,5,5,5)` has a total length of 30) Assume that you have prior knowledge, which allows you to estimate that the length of the pattern should be somewhere between 5 and 9 days. 

Try rerunning the Query function with an adjusted **window.length** based on your prior knowledge. Try different lengths until you find a match. If you you are unable to find a match after several tries, refer to the documentation over **window.length** to ensure that you are passing it correct values.

#Part 4: Distinctive Feature

Run the following command in the R console to import a time series for this exercise.
```{r, fig.show='hold', eval=TRUE}
part4.ts <- xts(read.csv("tutorial_data/part4_ts.csv")[[2]], 
              order.by = as.POSIXct(read.csv("tutorial_data/part4_ts.csv")[[1]]))
```

Run the following command in the R console to create a pattern template.
```{r, fig.show='hold', eval=TRUE}
part4.pattern <- CreateCustomTimeSeries(
  values = c(0,-4,-3,-8,-3,-4,0),
  intervals = c(5,5,5,5,5,5)
)
```

An appropriate **window.length** for this pattern is 5 days. Assume that you have prior knowledge that the normal range of values for this time series is between 85 and 100. A marked feature of the pattern you are searching for is that the central peak drops below this range (i.e. the central peak drops below 85). 

Using this information, try to implement a **distinctive.feature** that will decrease the running time of this query. You may use the `system.time()` function to record the elapsed time of the function like so:

```{r, fig.show='hold', eval=TRUE}
time.without.df <- system.time(
  Query(
    part4.ts,
    part4.pattern,
    window.length = 60*60*24*5
  )
)
cat("Elapsed Time: ", time.without.df[[3]])
```

#Part 5: Ruleset

This exercise will use a list of 10 time series. Run the following command in the R console to import the list.
```{r, fig.show='hold', eval=TRUE}
part5.ts.list <- list()
for( i in 1:10 ){
  part5.ts.list[[i]] <- xts(read.csv( paste("tutorial_data/part5_ts_", i,".csv", sep="") )[[2]], 
              order.by = as.POSIXct(read.csv( paste("tutorial_data/part5_ts_", i,".csv", sep="") )[[1]]))
}

part4.pattern <- CreateCustomTimeSeries(
  values = c(0,-4,-3,-8,-3,-4,0),
  intervals = c(5,5,5,5,5,5)
)
```

```{r, fig.show='hold', eval=TRUE}
part5.pattern <- CreateCustomTimeSeries(
  values = c(0, 10, 5, 15, 5, 10, 0),
  intervals = c(5,5,5,5,5,5)
)
```

TODO: Provide a dataset with lots of patterns, and ask users to use the rulset parameter to make it return only the ones that have some particular quality about them.



TODO: Invite them to use with their own dataset if they'd like.

#Part 6: Questionnaire 

Add questions to questionnaire about if they used their own dataset

The command below will save everything you have typed during this session into a file called "evaluation.Rhistory". It will then print the contents of that file to your console. Please copy and paste this command into the R console and run it. Then copy and paste the output into the Google form before. Once you have done this, please answer the rest of the questions on the form.

```{r, fig.show='hold', eval=FALSE}
savehistory("evaluation.Rhistory")  
scan('evaluation.Rhistory','character', sep = "\n"). 
```


Google form goes here

#Part 7: Debriefing



Insert filled in text from debrief-script-template here
